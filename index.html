<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]>      <html class="no-js"> <!--<![endif]-->
<html>
    <head>
        <link rel="manifest" href="manifest.json" />
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>Asset Tiger Bulk Printer</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="">
        <script src="PapaParse-5.0.2/papaparse.min.js"></script>
        <script src="BrowserPrint-Zebra-1.1.250.min.js"></script>
    </head>
    <body>
        <!--[if lt IE 7]>
            <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="#">upgrade your browser</a> to improve your experience.</p>
        <![endif]-->
        <main>
            <input type="file" accept=".csv" id="csvFileInput">
            <button id="printButton">Print CSV</button>
        </main>
        
        <script src="" async defer> 
        let parsedData; // this is keep parsed data from papa Parse

        document.getElementById('printButton').addEventListener('click', function () {
            const fileInput = document.getElementById('csvFileInput');
            const file = fileInput.files[0];
            
            if (file) {
                // Handle the CSV file here (e.g., parse and format data).
                const csvData = parseCSV(file);

                // Initiate the print action here (Ebra printer integration would go here).
                printCSV(csvData);
            } else {
                alert('Please select a CSV file.');
            }
        });

        function parseCSV(file) {
            // Uing PAPA framework
            Papa.parse(file, {
                header:true,
                dynamicTYping: true,
                complete: function(results){
                    parsedData = results.data;
                    console.log(parsedData);
                }
            });
        }

        function printCSV(dataToBePrinted) {
            // this will print data received from ParsedData
            // we loop through the parsed data
            dataToBePrinted.forEach(rowData => {
                const zplBarCodeCommand = `^XA\n^FO100,100^BY2\n^BCN,100,Y,N,N\n^FD${rowData['Asset Tag ID']}^FS\n^XZ`;

                // ******Structure of Code taken from ASSETBOX*********
                BrowserPrint.getDefaultDevice("printer", function(device) {
                    // Success callback function
                    console.log("Attempting connection to printer");
                    console.log(device);
                    device.send(barcode_str, function(success) {
                        // Inner success callback function
                        console.log("Successfully sent job to the printer");
                        }, function(error) {
                            // Inner error callback function
                            console.error("Error:" + error);
                            });
                            }, function(error) {
                                // Outer error callback function
                                console.log("Problems connecting to the printer");
                                });

                }); }
    </script>
    </body>
